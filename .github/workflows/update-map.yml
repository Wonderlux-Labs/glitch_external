name: Deploy Static Cube Map
on:
  workflow_dispatch:       # Allow manual triggers
  push:
    branches: [ main ]     # Deploy on pushes to main

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write      # Needed to commit updates
      pages: write         # Needed for GitHub Pages
      id-token: write      # Needed for Pages deployment
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Prepare Static Data
        run: |
          echo "Setting up static location data"
          
          # Use a static location for GitHub Pages (Center Camp area)
          cat > location.json << 'EOF'
          {
            "lat": 40.7864,
            "lng": -119.2065,
            "timestamp": "2025-08-19T00:00:00Z",
            "source": "static",
            "zone": "center_camp",
            "address": "Center Camp",
            "intersection": {
              "radial": "6:00",
              "arc": "Esplanade",
              "radial_distance": 0,
              "arc_distance": 0
            },
            "landmarks": [
              {
                "name": "Center Camp",
                "type": "center_camp",
                "distance_meters": 0.0
              }
            ],
            "within_fence": true,
            "distance_from_man": "2400 feet",
            "lat_lng": {
              "lat": 40.7864,
              "lng": -119.2065
            }
          }
          EOF
          
          # Use existing landmarks file
          cp public/geojson/burning_man_landmarks.json landmarks.json
          
          echo "Static location set to Center Camp"
          
      - name: Generate Static Page
        run: |
          # Use the static template
          cp static-template.html index.html
          
          # Create the data injection script
          cat > data_injection.js << 'EOF'
          <script>
          window.CUBE_LOCATION = LOCATION_DATA_PLACEHOLDER;
          window.LANDMARKS_DATA = LANDMARKS_DATA_PLACEHOLDER;
          window.LAST_UPDATE = 'LAST_UPDATE_PLACEHOLDER';
          window.STATIC_MODE = true;
          </script>
          EOF
          
          # Replace placeholders with actual data
          sed -i "s/LOCATION_DATA_PLACEHOLDER/$(cat location.json | jq -c .)/g" data_injection.js
          sed -i "s/LANDMARKS_DATA_PLACEHOLDER/$(cat landmarks.json | jq -c .)/g" data_injection.js
          sed -i "s/LAST_UPDATE_PLACEHOLDER/$(date -u +%Y-%m-%dT%H:%M:%SZ)/g" data_injection.js
          
          # Inject the data into the HTML
          sed -i '/<!--DATA_INJECTION_POINT-->/r data_injection.js' index.html
          sed -i '/<!--DATA_INJECTION_POINT-->/d' index.html
          
          # Copy all static assets
          cp -r public/* ./
          
          # Debug: Show what we generated
          echo "Generated index.html size: $(wc -c < index.html) bytes"
          echo "First 500 chars of location data:"
          head -c 500 location.json
          
      - name: Setup Pages
        uses: actions/configure-pages@v4
        
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'
          
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4